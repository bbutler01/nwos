---
title: "Using the nwos package"
author: "Brett J. Butler"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
---

This vignette shows the basic steps necessary to generate estimates using the nwos package. The package can be downloaded from GitHub (devtools::install_git("git://github.com/bbutler01/nwos.git")). The examples below use the XX dataset supplied with the package. Estimates can be generated for totals, proportions, means, and associated variances.

The basic steps are:
* Generate replicates (used for variance estimates)
* Estimate stratum areas
* Calculate response rates
* Calculate weights
* Generate estimates, including variances

These steps are repeated for each combination of state, stratum (e.g., family forest owners), and domain. The basic estimators assume the data supplied are for an individual state. Wrapper functions can be developed for iterating through states, strata, domains, and variables.


## General setup: Install/load packages
```{r setup}
# library(devtools)
# setwd("..")
# install("nwos")
# setwd("nwos")
# devtools::install_git("git://github.com/bbutler01/nwos.git")
library(nwos)
library(tidyverse)
```

Datasets need to have, at a minimum, the following variables:
* STRATUM
* POINT_COUNT
* ACRES_FOREST
* RESPONSE
* etc.

Optional:
* DOMAIN

Other data that are needed:
* STATE_AREA

Run by STATE

This vingette assumes the data are from one state and there is only one stratum. Additional states and stratum are calculated by looping through the approriate levels.

## Load data
```{r load data}
wi <- tbl_df(read.csv("../data/wi.csv")) 
wi <- wi %>% mutate(ROW_NAME = row.names(wi),
                    AC_WOOD = ACRES_FOREST)
```

## Generate Replicates

Replicates are used in the bootrstrapping variance estimation. Replicates are generated just once to increase processing efficiency, in order to use the same replicates across all estimates, and to facilitate repeatability of the results. This vignette uses only 100 replicates in order to decrease processing time. An actual application would likley use many more replicates, e.g., $R = 5,000$.

```{r replicates}
WI_REPLICATES <- nwos_replicates(index = row.names(wi), point.count = wi$POINT_COUNT, R = 100)
```

## Estimate acreage in stratum

A dummy variable indicating inclusion in a stratum must be created, e.g., family forest ownerships (FFO). Area are estimated for the stratum of interest. These values must also be estimated for each of the replicates.

```{r stratum_area}
wi <- wi %>% mutate(FFO = if_else(LAND_USE == 1 & OWN_CD == 45 & AC_WOOD >= 1, 1, 0)) # Add stratum variable, FFO
WI_FFO_AREA <- nwos_stratum_area(stratum = wi$FFO, point.count = wi$POINT_COUNT, state.area = 33898733)
WI_FFO_AREA_REP <- sapply(WI_REPLICATES, nwos_stratum_area_replicates, data = wi, stratum.name = "FFO", state.area = 33898733)
```

## Calculate response rates

Response rates need to be calculated for each stratum of interest, and the associated replicates. 

```{r response_rates}
wi <- wi %>% mutate(RESPONSE = if_else(RESPONSE_PROPENSITY >= 0.5, 1, 0)) %>%
  mutate(RESPONSE = if_else(is.na(RESPONSE_PROPENSITY), 0, RESPONSE))
WI_FFO_RR <- nwos_response_rate(stratum = wi$FFO, point.count = wi$POINT_COUNT, response = wi$RESPONSE)
WI_FFO_RR_REP <- sapply(WI_REPLICATES, nwos_response_rate_replicates, data = wi, stratum.name = "FFO", response.name = "RESPONSE")
```

## Generate weights
```{r weights}
wi$WEIGHT <- nwos_weights(stratum = wi$FFO, point.count = wi$POINT_COUNT, 
                               response = wi$RESPONSE, owner.area = wi$AC_WOOD, 
                               stratum.area = WI_FFO_AREA, response.rate = WI_FFO_RR)
WI_FFO_WEIGHTS_REP <- lapply(1:length(WI_REPLICATES), nwos_weights_replicates, 
                             index.rep = WI_REPLICATES, data = wi, 
                             stratum.area.rep = WI_FFO_AREA_REP, response.rate.rep = WI_FFO_RR_REP)
```

## Generate estimates - totals
```{r totals}
WI_FFO_OWN_TOTAL <- nwos_total(weight = wi$WEIGHT)
wi <- wi %>% mutate(OWNER = 1)
WI_FFO_OWN_TOTAL_REP <- sapply(1:length(WI_REPLICATES), nwos_total_replicates, index.rep = WI_REPLICATES, data = wi,
                       weight.rep = WI_FFO_WEIGHTS_REP,
                       owner.area.name = "OWNER",
                       domain.name = "FFO",
                       variable.name = "FFO")
WI_FFO_AC_TOTAL <- nwos_total(weight = wi$WEIGHT, area = wi$AC_WOOD)
WI_FFO_AC_TOTAL_REP <- sapply(1:length(WI_REPLICATES), nwos_total_replicates, index.rep = WI_REPLICATES, data = wi,
                       weight.rep = WI_FFO_WEIGHTS_REP,
                       owner.area.name = "AC_WOOD",
                       domain.name = "FFO",
                       variable.name = "FFO")

```

## Proportions

## Means

## Quantiles, including medians

## Estimate proportion ($Y_1$)

## Estimate mean (size of forest holdings)
